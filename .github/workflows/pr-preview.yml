name: Deploy PR Preview with Traefik

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          PR=${{ github.event.pull_request.number }}
          docker build ./app -t pr-preview-example:pr-${PR}

      - name: Deploy to VPS
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          echo "$VPS_SSH_KEY" > id_rsa
          chmod 600 id_rsa

          docker save pr-preview-example:pr-${PR_NUMBER} | \
            ssh -o StrictHostKeyChecking=no -i id_rsa \
            ${VPS_USER}@${VPS_HOST} "docker load"

          ssh -o StrictHostKeyChecking=no -i id_rsa \
            ${VPS_USER}@${VPS_HOST} bash << 'EOF'
              PR="${PR_NUMBER}"
              DOMAIN="${DOMAIN}"
              
              docker rm -f pr-preview-${PR} 2>/dev/null || true

              docker run -d \
                --name pr-preview-${PR} \
                --network traefik \
                -e PR_NUMBER=${PR} \
                -l "traefik.enable=true" \
                -l "traefik.docker.network=traefik" \
                -l "traefik.http.routers.pr-preview-${PR}.rule=Host(\`pr-${PR}.${DOMAIN}\`)" \
                -l "traefik.http.routers.pr-preview-${PR}.entrypoints=websecure" \
                -l "traefik.http.routers.pr-preview-${PR}.tls=true" \
                -l "traefik.http.routers.pr-preview-${PR}.tls.certresolver=letsencrypt" \
                -l "traefik.http.services.pr-preview-${PR}.loadbalancer.server.port=3000" \
                pr-preview-example:pr-${PR}
          EOF

          rm -f id_rsa

  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest

    steps:
      - name: Remove PR Preview
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          echo "$VPS_SSH_KEY" > id_rsa
          chmod 600 id_rsa

          ssh -o StrictHostKeyChecking=no -i id_rsa \
            ${VPS_USER}@${VPS_HOST} \
            "docker rm -f pr-preview-${PR_NUMBER} 2>/dev/null || true; docker rmi pr-preview-example:pr-${PR_NUMBER} 2>/dev/null || true"

          rm -f id_rsa
